{% extends "base.html" %}
{% load static %}
{% load tz %}
{% block content %}

<style>
        body { background: #f5f6fa; }
        .wallet-card {
            background: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
            margin-top: 40px;
        }
        .balance-amount {
            font-size: 2rem;
            font-weight: bold;
        }
        .history {
            max-height: 320px;
            overflow-y: auto;
        }
        .badge-credit { background: #28a745; }
        .badge-debit { background: #dc3545; }
    </style>

<!-- Breadcrumb -->
<div class="container py-3">
  <div class="row">
            {% include "users/user_profile_sidebar.html" %}
    </div>
    
    <!-- Profile Details -->
    <div class="col-md-9 py-2">
        <div class="profile-card">
                       
       
            <h3 class="mb-4 text-center">My Wallet</h3>
            <div class="mb-4 text-center">
                <span class="text-secondary">Current Balance</span><br>
                <span class="balance-amount" id="wallet-balance">₹{{ wallet.balance }}</span>
            </div>
            <div class="mb-3 d-flex justify-content-center">
                
                <a class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addMoneyModal">
                    Add Money
                </a>
            </div>
            <h5 class="mb-3">Transaction History</h5>
            <div class="table-responsive">
    <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-light">
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% for t in transactions %}
            <tr>
                <td>{{ t.created_at|localtime }}</td>
                <td>
                    {% if t.transaction_type == "credit" %}
                        <span class="badge bg-success">Credit</span>
                    {% else %}
                        <span class="badge bg-danger">Debit</span>
                    {% endif %}
                </td>
                <td>₹{{ t.amount }}</td>
                <td>{{ t.description }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="text-muted">No transactions yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

        

    <!-- Add Money Modal -->
    <div class="modal fade" id="addMoneyModal" tabindex="-1" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="add-money-form">
              <div class="modal-header">
                <h5 class="modal-title" id="addMoneyModalLabel">Add Money to Wallet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="add-amount" class="form-label">Amount</label>
                  <input type="number" class="form-control" id="add-amount" placeholder="Enter amount" required min="1">
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add Money</button>
              </div>
          </form>
        </div>
      </div>
    </div>      
            
        
      
    </div>
  </div>
</div>
</div>


    <!-- Bootstrap JS and necessary scripts -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById('add-money-form').addEventListener('submit', function(e){
    e.preventDefault();
    const amountInput = document.getElementById('add-amount').value;

    fetch("{% url 'create_wallet_order' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: "amount=" + amountInput
    })
    .then(res => res.json())
    .then(order => {
        var options = {
            "key": order.key_id,
            "amount": order.amount,
            "currency": "INR",
            "name": "Wallet Recharge",
            "order_id": order.order_id,
            "handler": function (response){
                response.amount = order.amount;  
                fetch("{% url 'verify_wallet_payment' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify(response)
                }).then(res => res.json())
                  .then(data => {
                      alert(data.message);
                      location.reload();
                  });
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
    });
});

</script>

{% endblock %}
