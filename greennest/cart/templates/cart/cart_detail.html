{% extends "base.html" %}
{% load static %}
{% block cart %}

<div class="container my-5">
  <h3 class="mb-4">My Cart</h3>
  <div class="row">
    <!-- Cart Items -->
    <div class="col-lg-8 mb-4">
      <table class="table cart-table border rounded text-center align-middle">
        <thead class="table-light">
          <tr>
            <th class="text-start">Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
          <tr class="{% if item.variant.stock == 0 %}text-muted{% endif %}">
            <!-- Product -->
            <td class="text-start">
              <div class="d-flex align-items-center">
                {% with first_image=item.variant.images.all|slice:":1"|first %}
                  {% if first_image %}
                    <img src="{{ first_image.image.url }}" alt="{{ item.variant.name }}" width="80" class="me-3 rounded">
                  {% else %}
                    <img src="https://via.placeholder.com/80" alt="{{ item.variant.name }}" class="me-3 rounded">
                  {% endif %}
                {% endwith %}
                <div>
                  <p class="mb-1 fw-bold">{{ item.variant.product.name }} - ({{ item.variant.variant_type }})</p>
                  {% if item.variant.stock > 0 %}
                    <small class="text-success">In Stock</small>
                  {% else %}
                    <small class="text-danger">Out of Stock</small>
                  {% endif %}
                  <br>
                  <a href="{% url 'remove_from_cart' item.id %}?next={{ request.path }}" class="text-danger small">Remove</a>
                </div>
              </div>
            </td>

            <!-- Price -->
            <td class="align-middle">
              {% if item.offer_applied and item.discounted_price < item.variant.price %}
                <span class="text-danger">₹{{ item.discounted_price }}</span><br>
                <small class="text-muted"><del>₹{{ item.variant.price }}</del></small>
              {% else %}
                ₹{{ item.variant.price }}
              {% endif %}
            </td>

            <!-- Quantity -->
           <td class="align-middle">
            <div class="d-flex justify-content-center align-items-center gap-2">
              {% if item.variant.stock > 0 %}
                <button class="btn btn-outline-secondary btn-sm cart-qty-btn"
                        data-item-id="{{ item.id }}" data-action="decrement">-</button>

                <span id="qty-{{ item.id }}">{{ item.quantity }}</span>

                <button class="btn btn-outline-secondary btn-sm cart-qty-btn"
                        id="btn-plus-{{ item.id }}"
                        data-item-id="{{ item.id }}" data-action="increment"
                        {% if item.quantity >= item.variant.stock or item.quantity >= 5 %}disabled{% endif %}>
                  +
                </button>
              {% else %}
                Out of stock
              {% endif %}
            </div>
          </td>


            <!-- Total -->
            <td id="item-total-{{ item.id }}" class="align-middle">
              {% if item.offer_applied and item.discounted_price != item.variant.price %}
                <span class="text-danger">₹{{ item.final_total }}</span><br>
                <small class="text-muted"><del>₹{{ item.variant.price|floatformat:2 }}</del></small>
              {% else %}
                ₹{{ item.final_total }}
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4">Your cart is empty.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Order Summary -->
{% if cart_items %}
<div class="col-lg-4">
  <div class="order-summary border p-3 rounded bg-white">
    <h5 class="mb-3">Order Summary</h5>

    <p class="d-flex justify-content-between">
      <span>Item Sub Total</span>
      <span id="cart-subtotal">₹{{ subtotal }}</span>
    </p>

    {% if total_discount > 0 %}
    <p class="d-flex justify-content-between text-success">
      <span>You Saved</span>
      <span id="cart-discount">- ₹{{ total_discount }}</span>
    </p>
    {% endif %}

    <p class="d-flex justify-content-between">
      <span>Shipping</span>
      <span>
        {% if subtotal > 0 and cart.shipping_charge > 0 %}
          ₹{{ cart.shipping_charge }}
        {% else %}
          Free
        {% endif %}
      </span>
    </p>

    <hr>

    <p class="d-flex justify-content-between fw-bold">
      <span>Total</span>
      <span id="cart-total">₹{{ grand_total }}</span>
    </p>

    {% if out_of_stock_items %}
      <button class="btn btn-secondary w-100" disabled>
        Cannot Checkout (Out of Stock Items)
      </button>
    {% else %}
      <a href="{% url 'checkout_address' %}" class="btn btn-success w-100">
        CHECKOUT
      </a>
    {% endif %}
  </div>
</div>
{% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.querySelectorAll('.cart-qty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const itemId = btn.dataset.itemId;
        const action = btn.dataset.action;

        fetch("{% url 'update_cart_quantity' 0 'increment' %}".replace("0/increment", `${itemId}/${action}`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`qty-${itemId}`).innerText = data.quantity;
                document.getElementById(`item-total-${itemId}`).innerText = `₹${data.item_total}`;
                document.getElementById('cart-subtotal').innerText = `₹${data.subtotal}`;
                document.getElementById('cart-total').innerText = `₹${data.grand_total}`;

                if (document.getElementById('cart-discount')) {
                    document.getElementById('cart-discount').innerText = `- ₹${data.total_discount}`;
                }

                const plusBtn = document.getElementById(`btn-plus-${itemId}`);
                if (plusBtn) {
                    plusBtn.disabled = !data.can_increment;
                }
            }
        });
    });
});
</script>


{% endblock cart %}
