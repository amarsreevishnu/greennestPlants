{% extends "greenest_admin/base.html" %}
{% load static %}

{% block admin_add_products %}
<link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<style>
  .img-thumb {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
  }
</style>


<div class="col-lg-10 p-0" style="background: #f8f9fa;">
  <div class="main-content">

    <!-- Top Section -->
    <div class="content-section d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h4 class="fw-bold mb-1">Add Products</h4>
        <div class="text-muted small">Admin &gt; Products</div>
      </div>
    </div>

    <!-- Add Product Form -->
    <section class="content-section d-flex justify-content-between align-items-center flex-wrap ">
      <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row g-4">

        <!-- Product Title -->
        <div class="col-md-6">
          <label class="form-label">Product Title</label>
          <input type="text" class="form-control" name="name" placeholder="Enter product name" required>
        </div>

        <!-- Category -->
        <div class="col-md-6">
          <label class="form-label">Category</label>
          <select class="form-select" name="category" required>
            <option value="">Select Category</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Watering Instructions -->
        <div class="col-md-6">
          <label class="form-label">Watering Instructions</label>
          <input type="text" class="form-control" name="watering" placeholder="e.g., Water twice a week">
        </div>

        <!-- Light Requirement -->
        <div class="col-md-6">
          <label class="form-label">Light Requirement</label>
          <input type="text" class="form-control" name="light_requirement" placeholder="e.g., Full Sun / Partial Shade / Indoor">
        </div>

        <!-- Description -->
        <div class="col-12">
          <label class="form-label">Description</label>
          <textarea class="form-control" name="description" rows="3"></textarea>
        </div>

        <!-- Active Checkbox -->
        <div class="col-12">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" name="is_active" id="is_active">
            <label class="form-check-label" for="is_active">Active</label>
          </div>
        </div>

        <!-- Variants Section -->
        <div class="col-12">
          <h5>Variants</h5>
          <div id="variants-container">
            <!-- First variant displayed by default -->
            <div class="variant-wrapper">
              <div class="mb-2 d-flex gap-2 align-items-center">
                <input type="text" name="variant_type[]" class="form-control" placeholder="Enter variant name" required>
                <input type="number" name="price[]" class="form-control" placeholder="Price" step="0.01" required>
                <input type="number" name="stock[]" class="form-control" placeholder="Stock" min="0" required>
              </div>

              <div class="mb-2">
                <label>Variant Images (max 3)</label>
                <input type="file" class="form-control" name="variant_images_0" accept="image/*" multiple onchange="previewVariantImages(this, 0)">
                <div id="variantPreview_0" class="d-flex gap-2 mt-2 flex-wrap"></div>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addVariant()">+ Add Variant</button>
        </div>


        <!-- Submit -->
        <div class="col-12 mt-3">
          <button type="submit" class="btn px-4 text-white" style="background:#004F44">Save Product</button>
        </div>

      </div>
    </form>
  </div>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="overflow:auto; text-align:center;">
        <img id="cropperImage" style="width:100%; max-height:80vh; object-fit:contain;">
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="saveCrop">Save Crop</button>
      </div>
    </div>
  </div>
</div>

<!-- View Image Modal -->
<div class="modal fade" id="viewImageModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="viewImage" style="width:100%; max-height:80vh; object-fit:contain;">
      </div>
    </div>
  </div>
</div>

    </section>

  </div>
</div>



<script>

let variantIndex = 1;
let cropper, currentPreviewElem, currentHiddenInput;

function addVariant() {
  const container = document.getElementById('variants-container');

  const div = document.createElement('div');
  div.classList.add('variant-wrapper');

  div.innerHTML = `
    <div class="mb-2 d-flex gap-2 align-items-center">
      <input type="text" name="variant_type[]" class="form-control" placeholder="Enter variant name" required>
      <input type="number" name="price[]" class="form-control" placeholder="Price" step="0.01" required>
      <input type="number" name="stock[]" class="form-control" placeholder="Stock" min="0" required>
      <button type="button" class="btn btn-sm btn-light" onclick="removeVariant(this)">Ã—</button>
    </div>

    <div class="mb-2">
      <label>Variant Images (max 3)</label>
      <input type="file" class="form-control" name="variant_images_${variantIndex}" accept="image/*" multiple onchange="previewVariantImages(this, ${variantIndex})">
      <div id="variantPreview_${variantIndex}" class="d-flex gap-2 mt-2 flex-wrap"></div>
    </div>
  `;

  container.appendChild(div);
  variantIndex++;
}

function removeVariant(button) {
  button.closest('.variant-wrapper').remove();
}

// Preview images + crop button
function previewVariantImages(input, index) {
  const previewContainer = document.getElementById(`variantPreview_${index}`);
  previewContainer.innerHTML = "";

  const files = Array.from(input.files).slice(0, 3); // limit to 3 images
  files.forEach((file, i) => {
    const reader = new FileReader();
    reader.onload = function(evt) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('position-relative');

      wrapper.innerHTML = `
        <img src="${evt.target.result}" class="img-thumb" data-original="${evt.target.result}">
        <input type="hidden" name="variant_${index}_cropped_${i}" id="variantHidden_${index}_${i}">
        
        <!-- Crop Button -->
        <button type="button" class="btn btn-sm btn-light position-absolute bottom-0 end-0 me-5"
                onclick="openCropper(this.parentElement.querySelector('img'), 'variantHidden_${index}_${i}')">
          <i class="bi bi-crop"></i>
        </button>

        <!-- View Button -->
        <button type="button" class="btn btn-sm btn-light position-absolute bottom-0 end-0"
                onclick="viewImage(this.parentElement.querySelector('img'))">
          <i class="bi bi-eye"></i>
        </button>
      `;
      previewContainer.appendChild(wrapper);
    };
    reader.readAsDataURL(file);
  });
}


// Cropper modal functions
function openCropper(previewElem, hiddenInputId) {
  currentPreviewElem = previewElem;
  currentHiddenInput = hiddenInputId;

  // Use original (not 80px thumbnail)
  document.getElementById('cropperImage').src = previewElem.dataset.original;

  const modal = new bootstrap.Modal(document.getElementById('cropperModal'));
  modal.show();

  document.getElementById('cropperImage').onload = function() {
    if (cropper) cropper.destroy();
    cropper = new Cropper(document.getElementById('cropperImage'), { 
      aspectRatio: 1,
      viewMode: 1
    });
  };
}

document.getElementById('saveCrop').addEventListener('click', function() {
  const canvas = cropper.getCroppedCanvas({
    width: 500,
    height: 500,
  });

  // Convert cropped image to base64
  const croppedBase64 = canvas.toDataURL("image/jpeg");

  // Update preview image
  currentPreviewElem.src = croppedBase64;

  // Save cropped base64 into hidden input
  document.getElementById(currentHiddenInput).value = croppedBase64;

  bootstrap.Modal.getInstance(document.getElementById('cropperModal')).hide();
});



function viewImage(previewElem) {
  document.getElementById('viewImage').src = previewElem.src;
  const modal = new bootstrap.Modal(document.getElementById('viewImageModal'));
  modal.show();
}

</script>

{% endblock %}
