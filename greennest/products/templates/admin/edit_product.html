{% extends "greenest_admin/base.html"%}
{% load static %}

{% block admin_edit_products %}

<style>
  .img-thumb {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
  }

  
</style>

<!-- Main content area -->
    <div class="col-lg-10 p-0" style="background: #f8f9fa;">
      <div class="main-content">

        <!-- Top section -->
        <div class="content-section d-flex justify-content-between align-items-center flex-wrap">
          <div>
            <h4 class="fw-bold mb-1">Edit Product</h4>
            <div class="text-muted small">Admin &gt; Products</div>
          </div>
          <div class="d-flex align-items-center mt-2 mt-lg-0 me-5 ">
            <form class="d-none d-md-block me-5">
              <input class="form-control rounded-pill px-3" placeholder="Search " type="search" style="min-width:200px;">
            </form>
            <div class="d-flex align-items-center"> 
            </div>
          </div>
        </div>

        <!-- Table section -->
        <div class="content-section">
          <div class="table-responsive">
            <!-- Add Product Form -->
      <section class="rounded-form mx-3 my-3">
       
        
   <form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="row g-4">

    <!-- Product Name -->
    <div class="col-md-6">
      <label class="form-label">Product Title</label>
      <input type="text" class="form-control" name="name" value="{{ product.name }}" required>
    </div>

    <!-- Category Dropdown -->
    <div class="col-md-6">
      <label class="form-label">Category</label>
      <select class="form-select" name="category" required>
        <option value="">Select Category</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if cat.id == product.category.id %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Watering  -->
    <div class="col-md-6">
      <label class="form-label">Watering Instructions</label>
      <input type="text" class="form-control" name="watering" value="{{ product.watering }}" >
    </div>
    
    <!-- Light Requirement -->
    <div class="col-md-6">
      <label class="form-label">Light Requirement</label>
      <input type="text" class="form-control" name="light_requirement" value="{{ product.light_requirement }}">
    </div>
    <!-- Description -->
    <div class="col-12">
      <label class="form-label">Description</label>
      <textarea class="form-control" rows="3" name="description">{{ product.description }}</textarea>
    </div>

    <!-- Active Checkbox -->
    <div class="col-12">
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %}>
        <label class="form-check-label" for="is_active">Active</label>
      </div>
    </div>

    <!-- Product Variants -->
    <div id="variants" class="mb-2">
   {% for variant in variants %}
  <div class="variant mb-1 d-flex gap-2 align-items-center" data-variant-id="{{ variant.id }}">
    <input type="hidden" name="variant_id[]" value="{{ variant.id }}">
<div class="row g-2 align-items-center">
      <div class="col-md-4">
          <input type="text" name="variant_type[]" class="form-control" placeholder="Growth Stage" value="{{ variant.variant_type }}" required>
      </div>
      <div class="col-md-3">
          <input type="number" name="price[]" class="form-control" placeholder="Price" step="0.01" value="{{ variant.price }}" required>
      </div>
      <div class="col-md-3">
          <input type="number" name="stock[]" class="form-control" placeholder="Stock" value="{{ variant.stock }}">
      </div>
      <div class="col-md-2">
          <button type="button" class="btn btn-danger btn-sm" onclick="removeVariant(this)">Remove</button>
      </div>
    </div>
    <div class="variant-images mt-3">
                    {% for img in variant.ordered_images %}
                        <div class="variant-image-container" data-image-id="{{ img.id }}">
                            <img src="{{ img.image.url }}" class="img-thumb" alt="Variant Image">
                            <button type="button" class="remove-image-btn" onclick="removeImage(this)">Ã—</button>
                            <input type="hidden" name="existing_variant_images_{{ forloop.parentloop.counter0 }}[]" value="{{ img.id }}">
                        </div>
                    {% endfor %}

                    {% for i in "012" %}
                        <div style="margin-left:10px;">
                             <input type="file" name="variant_images_{{ forloop.parentloop.counter0 }}_{{ i }}" onchange="previewImage(event, this)">
                            <input type="hidden" name="variant_{{ forloop.parentloop.counter0 }}_cropped_{{ i }}">
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <p>No variants found.</p>
        {% endfor %}
    </div>
    <button type="button" class="btn btn-sm btn-secondary" onclick="addVariant()">Add Variant</button>
    <!-- Submit Button -->
    <div class="col-12">
      <button type="submit" class="btn mt-4 px-4 text-white" style="background-color:#004F44">Update Product</button>
    </div>
  </div>
  </form>
    </section>
   </div>
</div>



<script>
    function removeVariant(button) {
        button.closest('.variant-item').remove();
    }

    function removeImage(button) {
        const container = button.parentElement;
        const hiddenInput = container.querySelector('input[type=hidden]');
        if (hiddenInput) hiddenInput.remove();
        container.remove();
    }

    function addVariant() {
        const container = document.getElementById('variants-container');
        const index = container.children.length;

        const variantHtml = `
            <div class="variant-item border rounded p-3 mb-3" data-variant-id="">
                <input type="hidden" name="variant_id[]" value="">
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <input type="text" name="variant_type[]" class="form-control" placeholder="Growth Stage" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" name="price[]" class="form-control" placeholder="Price" step="0.01" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" name="stock[]" class="form-control" placeholder="Stock" value="0">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeVariant(this)">Remove</button>
                    </div>
                </div>

                <div class="variant-images mt-3">
                    <div style="margin-left:10px;">
                        <input type="file" name="variant_images_${index}_0" onchange="previewImage(event, this)">
                        <input type="hidden" name="variant_${index}_cropped_0">
                    </div>
                    <div style="margin-left:10px;">
                        <input type="file" name="variant_images_${index}_1" onchange="previewImage(event, this)">
                        <input type="hidden" name="variant_${index}_cropped_1">
                    </div>
                    <div style="margin-left:10px;">
                        <input type="file" name="variant_images_${index}_2" onchange="previewImage(event, this)">
                        <input type="hidden" name="variant_${index}_cropped_2">
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', variantHtml);
    }

    function previewImage(event, input) {
        // Optional: Implement client-side image preview or cropping here
        // For now, just placeholder to hook in image cropping if needed
    }
</script>




{% endblock admin_edit_products%}