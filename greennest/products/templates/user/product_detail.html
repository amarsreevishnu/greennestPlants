{% extends "base.html" %}
{% load static %}


{% block user_products_detials %}


<style>
  .wishlist-icon {
    border: 1px solid #ddd;
    border-radius: 50%;
    padding: 10px;
    cursor: pointer;
    color: #004f44;
  }
</style>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>


<!-- Breadcrumb -->
<div class="container mt-4 mb-1">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="#">Home</a></li>
      <li class="breadcrumb-item"><a href="#">Products</a></li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ product.name }}
      </li>
    </ol>
  </nav>
</div>


<!-- Main product section -->
<div class="container mb-5">
  <div class="row">
    <!-- Product Images -->
    <div class="col-md-4 d-flex">
      <div class="d-flex flex-column align-items-center me-3" id="thumbs-container">
        {% for img in additional_images|slice:":3" %}
          <img
            
            src="{{ img.image.url }}"
            class="thumb-image mb-2 shadow-sm"
            style="width: 60px; height: 80px; object-fit: cover; cursor: pointer"
          />
        {% endfor %}
      </div>
      <div>
        <img
          id="mainImage"
          src="{{ main_image.image.url }}"
          class="shadow"
          style="
            width: 280px;
            height: 360px;
            object-fit: cover;
            border-radius: 12px;
          "
        />
      </div>
    </div>


    <!-- Product Info -->
    <div class="col-md-5 pl-5">
      <h3 class="product-title">{{ product.name }}</h3>
      <div class="mb-2">
        <span class="rating text-warning">&#9733;</span> 4.6 | 814 reviews
      </div>
      <div class="mb-2">
        {% if cheapest_variant %}
          {% if best_offer %}
            <span id="variant-price" class="price">
              <strong>â‚¹ {{ discounted_price|floatformat:2 }}</strong>
            </span>
          
          {% else %}
            <span id="variant-price" class="price">
              <strong>â‚¹ {{ cheapest_variant.price }}</strong>
            </span>
          {% endif %}
        {% endif %}
      </div>
      <div class="product-details mb-2">
        <ul>
          <li>Light Requirement: {{ product.get_light_requirement_display }}</li>
          <li>Size: {{ product.get_size_display }}</li>
          <li>Category: {{ product.category.name }}</li>
        </ul>
      </div>
      <!-- Stock/Out of Stock Display -->
    <div id="stock-display">
      {% if cheapest_variant %}
          <div class="mt-2 text-success">
            <strong>Stock:</strong>
            <span id="variant-stock">{{ cheapest_variant.stock }}</span>
          </div>
        {% else %}
          <p class="mb-1 text-danger"><strong>Out of Stock</strong></p>
        
      {% endif %}
    </div>


      <!-- Variant Options -->
      {% if variants %}
      <div class="variants mt-3">
        <label><strong>Select Variant:</strong></label>
        <div class="d-flex gap-3 mt-2">
          {% for variant in variants %}
          <div>
            <input type="radio"
                  name="variant_id"
                  id="variant_{{ variant.id }}"
                  value="{{ variant.id }}"
                  data-price="{{ variant.price }}"
                  data-discounted-price="{{ variant.discounted_price }}"
                  data-stock="{{ variant.stock }}"
                  data-images="{% for img in variant.images.all %}{{ img.image.url }}{% if not forloop.last %},{% endif %}{% endfor %}"
                  data-in-wishlist="{% if variant.id in wishlist_variant_ids %}true{% else %}false{% endif %}"
                  {% if variant.id == cheapest_variant.id %}checked{% endif %} />
            <label for="variant_{{ variant.id }}">
              {{ variant.variant_type }}  
              <br>
              {% if variant.discounted_price < variant.price %}
                <span class="text-success">â‚¹{{ variant.discounted_price|floatformat:2 }}</span>
                <span class="text-muted text-decoration-line-through">â‚¹{{ variant.price }}</span>
              {% else %}
                â‚¹{{ variant.price }}
              {% endif %}
            </label>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}


      <!-- ðŸ”¹ Add to Cart Form -->
      <form method="POST" id="addToCartForm" action="{% url 'add_to_cart' 0 %}">
    {% csrf_token %}
    <!-- Hidden input to store selected variant -->
    <input type="hidden" name="variant_id" id="hidden-variant-id" value="{{ cheapest_variant.id }}">
    <div class="mt-1 d-flex gap-3 py-3">
        <label>Qty: </label>
        <input
            type="number"
            name="quantity"
            value="1"
            min="1"
            max="{% if cheapest_variant.stock > 5 %}5{% else %}{{ cheapest_variant.stock }}{% endif %}"
            id="qty-input"
            class="form-control text-center"
            style="width: 70px; height: 30px"
        />
        <button type="submit" id="add-to-cart-btn" class="btn btn-success px-4">
            ADD TO CART
        </button>
       <button type="button" 
        class="wishlist-btn" 
        data-variant="{{ cheapest_variant.id }}" 
        style="background:none; border:none; cursor:pointer;">
  <i id="wishlist-icon-{{ cheapest_variant.id }}" 
     class="fa fa-heart wishlist-icon {% if cheapest_variant.id in wishlist_variant_ids %}text-warning{% endif %}">
  </i>
</button>
    </div>
</form>


    </div>
</form>

   

    <!-- Cart Summary -->
    <div class="col-md-3">
      <div class="cart-summary mb-4">
        <strong>Your Cart</strong>
        {% for item in cart.items.all %}
        <div class="d-flex align-items-center mt-2">
          {% with first_image=item.variant.images.all|slice:":1"|first %}
                  {% if first_image %}
                    <img src="{{ first_image.image.url }}" alt="{{ item.variant.name }}" width="40" class="me-3 rounded">
                  {% else %}
                    <img src="https://via.placeholder.com/80" alt="{{ item.variant.name }}" class="me-3 rounded">
                  {% endif %}
                {% endwith %}
          <div>
            <div>{{ item.variant.product.name }}
              <div class="small text-muted">({{ item.variant.variant_type }})  â‚¹{{ item.variant.price }}</div></div>  
            <a href="{% url 'remove_from_cart' item.id %}?next={{ request.path }}" class="text-danger small">Remove</a>
          </div>
        </div>

        {% endfor %}
        <hr />
        <a  href="{% url "cart_detail" %}" class="btn btn-dark btn-sm w-100 mt-2">View Cart</a></button>
        <button class="btn btn-success btn-sm w-100 mt-2">Checkout</button>
        <div class="small text-muted mt-2">Ships from Kerala GreenNest</div>
      </div>
    </div>
  </div>
</div>
 </div>


<!-- Similar Collection (unchanged) -->
<div class="container mb-5">
  <h5>Similar Collection</h5>
  <div class="row mt-3">
    {% for related in product.category.products.all|slice:":4" %}
      {% if related.id != product.id %}
      <div class="col-6 col-md-3 mb-3 text-center">
        <a href="{% url 'user_product_detail' related.id %}">
          {% if related.variants.first and related.variants.first.images.all %}
            <img
              src="{{ related.variants.first.images.all.0.image.url }}"
              class="shadow-sm"
              style="
                width: 100%;
                max-width: 150px;
                height: 180px;
                object-fit: cover;
                border-radius: 8px;
              "
            />
          {% endif %}
        </a>
        <div class="mt-2">{{ related.name }}</div>
        {% if related.variants.first %}
        <div class="mt-2">â‚¹{{ related.variants.first.price }}</div>
        {% else %}
        <div class="mt-2"><span class="text-danger">Out of Stock</span></div>
        {% endif %}
        <div class="mt-1 d-flex justify-content-center gap-2">
          <a href="{% url 'user_product_detail' related.pk %}." class="btn btn-success px-1 w-100">View</a>
          <a href="{% url 'toggle_wishlist' related.id %}"><i class="fa fa-heart wishlist-icon"></i></a>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>
</div>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/elevatezoom/3.0.8/jquery.elevatezoom.min.js"></script>
<script>
$(document).ready(function () {
    const form = $("#addToCartForm");

    // Handle variant selection change
    $("input[name='variant_id']").on("change", function () {
        const variantId = $(this).val();
        const stock = $(this).data("stock");
        const price = parseFloat($(this).data("price"));
        const discountedPrice = parseFloat($(this).data("discounted-price"));
        const imagesData = $(this).data("images");
        const images = imagesData ? imagesData.split(",") : [];

        // âœ… Update form hidden input and action
        $("#hidden-variant-id").val(variantId);
        form.attr("action", "{% url 'add_to_cart' 0 %}".replace("0", variantId));

        // âœ… Update Price display
        if (discountedPrice < price) {
            const discountPercentage = Math.round(100 - (discountedPrice / price * 100));
            $("#variant-price").html(`
                <strong>â‚¹${discountedPrice.toFixed(2)}</strong>
                <span class="text-muted text-decoration-line-through ms-2">â‚¹${price.toFixed(2)}</span>
                <span class="offer text-success ms-2">- ${discountPercentage}% off</span>
            `);
        } else {
            $("#variant-price").html(`<strong>â‚¹${price.toFixed(2)}</strong>`);
        }

        // âœ… Update stock and quantity max
        $("#variant-stock").text(stock);
        $("#qty-input").attr("max", Math.min(stock, 5));

        const addBtn = $("#add-to-cart-btn");
        if (parseInt(stock) > 0) {
            addBtn.prop("disabled", false)
                .removeClass("btn-secondary")
                .addClass("btn-success")
                .text("ADD TO CART");
        } else {
            addBtn.prop("disabled", true)
                .removeClass("btn-success")
                .addClass("btn-secondary")
                .text("Out of Stock");
        }

        // âœ… Update main image and thumbnails
        if (images.length > 0) {
            $("#mainImage").attr("src", images[0]);
            const thumbsContainer = $("#thumbs-container");
            thumbsContainer.empty();

            images.forEach(function(img) {
                thumbsContainer.append(`
                    <img src="${img}" class="thumb-image mb-2 shadow-sm" 
                         style="width:60px;height:80px;object-fit:cover;cursor:pointer;">
                `);
            });

            // Re-bind click event for new thumbnails
            $(".thumb-image").off("click").on("click", function () {
                const newImage = $(this).attr("src");
                $("#mainImage").attr("src", newImage);
            });
        }

        // âœ… Optionally show selected variant type
        const label = $("label[for='variant_" + variantId + "']").text().trim();
        $("#selected-variant-type").text(label);
    });

    // âœ… Trigger change on page load to initialize view
    $("input[name='variant_id']:checked").trigger("change");
});




function initZoom() {
    // Remove any previous zoom instance
    $('#mainImage').removeData('elevateZoom');
    $('.zoomContainer').remove();

    // Initialize elevateZoom
    $('#mainImage').elevateZoom({
        zoomType: "inner",
        lensShape: "square",
        cursor: "crosshair", 
        lensSize: 150,
        scrollZoom: false,
        easing: true,
        zoomWindowFadeIn: 500,
        zoomWindowFadeOut: 500
    });
}

$(document).ready(function () {
    initZoom(); // Initialize on page load

    // Handle variant selection change
    $("input[name='variant_id']").on("change", function () {
        const imagesData = $(this).data("images");
        const images = imagesData ? imagesData.split(",") : [];

        // Update main image and thumbnails
        if (images.length > 0) {
            $("#mainImage").attr("src", images[0]);

            const thumbsContainer = $("#thumbs-container");
            thumbsContainer.empty();
            images.forEach(function(img) {
                thumbsContainer.append(`
                    <img src="${img}" class="thumb-image mb-2 shadow-sm" 
                         style="width:60px;height:80px;object-fit:cover;cursor:pointer;">
                `);
            });

            // Re-bind click event for thumbnails
            $(".thumb-image").off("click").on("click", function () {
                const newImage = $(this).attr("src");
                $("#mainImage").attr("src", newImage);
                initZoom(); // Re-initialize zoom on main image
            });

            initZoom(); // Re-initialize zoom after variant change
        }
    });

    // Trigger change on page load
    $("input[name='variant_id']:checked").trigger("change");
});

//  Wishlist AJAX Handling------------------------------------------

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie("csrftoken");

$(document).on("click", ".wishlist-btn", function(e) {
    e.preventDefault();
    let btn = $(this);
    let variantId = btn.data("variant");

    let toggleUrl = "{% url 'toggle_wishlist' 0 %}".replace("0", variantId);

    $.ajax({
        url: toggleUrl,
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        success: function(response) {
            if (response.status === "added") {
                $("#wishlist-icon-" + variantId).addClass("text-warning");
            } else {
                $("#wishlist-icon-" + variantId).removeClass("text-warning");
            }
            $("#wishlist-count").text(response.count);
        },
        error: function(xhr) {
            console.error("Wishlist error:", xhr.responseText);
            alert("Error updating wishlist. Please try again.");
        }
    });
});


// ðŸ”¹ Update hidden input + wishlist button when variant changes
$("input[name='variant_id']").on("change", function() {
    let variantId = $(this).val();
    $("#hidden-variant-id").val(variantId);

    // update wishlist button data + icon id
    $(".wishlist-btn").data("variant", variantId);
    $(".wishlist-btn i").attr("id", "wishlist-icon-" + variantId);

    // âœ… Check if this variant is already in wishlist
    let inWishlist = $(this).data("in-wishlist") === true || $(this).data("in-wishlist") === "true";
    if (inWishlist) {
        $("#wishlist-icon-" + variantId).addClass("text-warning");
    } else {
        $("#wishlist-icon-" + variantId).removeClass("text-warning");
    }
});



</script>



{% endblock user_products_detials %}
  