{% extends "base.html" %}
{% load static %}

{% block user_products_list %}

<style>

.product-card {
  border: none;
  transition: transform 0.2s ease;
  height: 100%;
  display: flex;
  flex-direction: column;
}
.product-card:hover {
  transform: translateY(-5px);
}
.wishlist-icon {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 1.2rem;
  cursor: pointer;
}


.product-card img {
  height: 250px;         
  width: 100%;           
  object-fit: contain;   /* contain keeps whole image visible */
  background: #f8f9fa;   /* adds neutral bg if image has empty space */
  padding: 10px;         /* prevent edge clipping */
  border-top-left-radius: 0.5rem;
  border-top-right-radius: 0.5rem;
}

/* Sidebar Styling */
.filter-sidebar {
  background: #f9f9f9;
  border-radius: 10px;
  padding: 20px;
  margin-right: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  min-height: 100%;   /* stretch with product grid */
}

.filter-title {
  font-size: 1.1rem;
  margin-bottom: 8px;
  font-weight: 600;
}

.form-check {
  margin-bottom: 5px;
}
</style>



<!-- Product_list-section -->
<section class="mb-4">
  <div class="container-fluid mt-2 pt-5">
    <div class="row">
      <!-- Sidebar Filters -->
      <div class="col-md-3">
        <div class="filter-sidebar">
          <div class="mb-4">
            <div class="filter-title">Search</div>
                <form method="get" class="mb-3 d-flex">
                  <input type="text" name="q" class="form-control" placeholder="Search products..."
                        value="{{ search_query|default:'' }}">
                          {% if search_query %}
                            <a href="{% url 'user_product_list' %}" class="btn btn-outline-secondary ms-2">✕</a>
                          {% endif %}
                </form>
          </div>
          <form method="get" id="filterForm">
            <div class="mb-4">
            <div class="filter-title">Categories</div>
              {% for cat in all_categories %}
                <div class="form-check">
                  <input type="checkbox" name="category" id="cat{{ cat.id }}" value="{{ cat.name }}" class="form-check-input"
                    {% if cat.name in categories %}checked{% endif %}>
                  <label class="form-check-label" for="cat{{ cat.id }}">{{ cat.name }}</label>
                </div>
              {% endfor %}

          </div>
          
        <div class="mb-4">
          <div class="filter-title">Light Requirement</div>
          <div class="form-check">
            <input type="checkbox" name="lights" value="Low" class="form-check-input"
              {% if "Low" in lights %}checked{% endif %}>
            <label class="form-check-label">Low Light</label>
          </div>
          <div class="form-check">
            <input type="checkbox" name="lights" value="Medium" class="form-check-input"
              {% if "Medium" in lights %}checked{% endif %}>
            <label class="form-check-label">Medium Light</label>
          </div>
          <div class="form-check">
            <input type="checkbox" name="lights" value="Bright" class="form-check-input"
              {% if "Bright" in lights %}checked{% endif %}>
            <label class="form-check-label">Bright Light</label>
          </div>
        </div>
      <div class="mb-4">
        <div class="filter-title">Price</div>
          <input type="number" name="min_price" class="form-control mb-2" placeholder="Min"
            value="{{ min_price|default:'' }}">
          <input type="number" name="max_price" class="form-control mb-2" placeholder="Max"
          value="{{ max_price|default:'' }}">
      </div>
          <hr>
        <button class="btn btn-dark w-100">Filter</button>  
          {% if categories or sizes or lights or min_price or max_price %}
            <a href="{% url 'user_product_list' %}" class="btn btn-outline-secondary w-100 mt-2 ">Clear Filters ✕</a>
          {% endif %}
        </div>
      </div>

      <!-- Product sort with A-Z and Price Low-High -->
      <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>Our Collection</h4>
          <form method="get" class="d-inline">
            <select name="sort" class="form-select w-auto" onchange="this.form.submit()">
                <option value="" disabled selected>Sort</option>
                <option value="name_asc" {% if sort_option == "name_asc" %}selected{% endif %}>Name: A → Z</option>
                <option value="name_desc" {% if sort_option == "name_desc" %}selected{% endif %}>Name: Z → A</option>  
                <option value="price_asc" {% if sort_option == "price_asc" %}selected{% endif %}>Price: Low → High</option>
                <option value="price_desc" {% if sort_option == "price_desc" %}selected{% endif %}>Price: High → Low</option>
            </select>
          </form>
        </div>
      <!-- Products Listing --> 
        
<div class="row g-4" id="product-container">
          {% for product in products %}
            <div class="col-md-4 col-sm-6">
              <div class="card product-card position-relative shadow-sm h-100">

                {% with variant=product.available_variants.0 %}
                  {% if variant %}
                    <!-- Wishlist icon -->
                    <a href="{% url 'toggle_wishlist' variant.id %}">
                      <i class="fa fa-heart wishlist-icon {% if variant.id in wishlist_variant_ids %}text-warning{% endif %}"></i>
                    </a>

                    <!-- Product image -->
                    {% with main_img=variant.images.all|first %}
                      {% if main_img %}
                        <img src="{{ main_img.image.url }}" class="card-img-top" alt="{{ product.name }}">
                      {% else %}
                        <img src="/static/images/no-image.png" class="card-img-top" alt="{{ product.name }}">
                      {% endif %}
                    {% endwith %}

                    <!-- Product info -->
                    <div class="card-body text-center d-flex flex-column">
                      <h6 class="card-title">{{ product.name }}</h6>
                      <p class="text-muted mb-2">
                        {% if variant.discounted_price and variant.discounted_price < variant.price %}
                          <span class="text-danger fw-bold">₹ {{ variant.discounted_price|floatformat:0 }}</span>
                          <del class="text-muted">₹ {{ variant.price|floatformat:0 }}</del>
                        {% else %}
                          <span>₹ {{ variant.price|floatformat:0 }}</span>
                        {% endif %}
                      </p>
                      <div class="mt-auto">
                        <a href="{% url 'user_product_detail' product.id %}" class="btn btn-success btn-sm w-100">View</a>
                      </div>
                    </div>
                  {% else %}
                    <img src="/static/images/no-image.png" class="card-img-top" alt="{{ product.name }}">
                    <div class="card-body text-center">
                      <h6 class="card-title">{{ product.name }}</h6>
                      <p>Price not available</p>
                    </div>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          {% empty %}
            <p class="text-center">No products available at the moment.</p>
          {% endfor %}
        </div>



        <div class="text-center mt-4">
          {% if products.has_next %}
            <button id="load-more" data-page="2" class="btn btn-outline-dark">Load More</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>





<script>
document.addEventListener("DOMContentLoaded", function () {
  const loadMoreBtn = document.getElementById("load-more");
  const container = document.getElementById("product-container");

  if (loadMoreBtn) {
    loadMoreBtn.addEventListener("click", function () {
      let page = this.dataset.page;

      fetch(`?page=${page}`, { headers: { "x-requested-with": "XMLHttpRequest" } })
      .then(res => res.json())
      .then(data => {
        data.products.forEach(p => {
          let col = document.createElement("div");
          col.classList.add("col-md-4", "col-sm-6");
          col.innerHTML = `
            <div class="card product-card position-relative shadow-sm h-100">
              <a href="${p.wishlist_url}">
                <i class="fa fa-heart wishlist-icon ${p.in_wishlist ? 'text-warning' : ''}"></i>
              </a>
              <img src="${p.variant_image || '/static/images/no-image.png'}" class="card-img-top" alt="${p.name}">
              <div class="card-body text-center d-flex flex-column">
                <h6 class="card-title">${p.name}</h6>
                <p class="text-muted mb-2">${p.price}</p>
                <div class="mt-auto">
                  <a href="${p.detail_url}" class="btn btn-success btn-sm w-100">View</a>
                  
                </div>
              </div>
            </div>
          `;
          container.appendChild(col);
        });

        if (data.has_next) {
          loadMoreBtn.dataset.page = parseInt(page) + 1;
        } else {
          loadMoreBtn.remove();
        }
      })
      .catch(err => console.error("Error loading products:", err));
    });
  }
});


</script>


{% endblock user_products_list %}